

# 代码审阅中我想得到什么

- 标注：考虑任何观点之前，必须充分考虑[代码审阅标准](https://github.com/Trojan0523/Code-Review-Docs/blob/main/eng-practices%20(%E5%B7%A5%E7%A8%8B%E5%B8%88%E5%AE%9E%E8%B7%B5).md)



## 设计

- 审查中最重要的部分应该是变更列表的整体设计。变更列表里面的各个代码块的交互是否有意义？这段变更在你的代码仓，还是库中？对于系统的其他部分，你的代码是否得到良好的集成方式？添加这段功能是最好时机吗？



## 功能

- 变更列表中的变更是否符合开发者的想法？开发者的想法是否对使用此段代码的开发者有益？"用户"通常包含端对端用户(当受最终代码变更影响时)和开发者(将来会使用这段代码的人)
- 大多数情况下，我们期待开发者能很好的测试自己的变更，以便审阅者能够将审阅工作正常开展下去。然而，作为一个开发者，对于边界情况仍然要多思考，找出并发问题，尝试站在用户(使用方开发者)角度思考，确保**所见即所得**，减少bug率.
- 有需要的时候，你自己也可以验证变更提交，当出现面向用户(比如用户界面变更)影响时，审阅者最重要的任务就是检查变更行为，阅读这些代码的时候，是比较难了解有些变更可能会影响用户使用的，对于这些变更，如果变更中不好去做修复的话，你可以让开发者给你一个这个功能的Demo做演示并且自己尝试修复。
- 另一方面，代码审阅期间如果变更中存在某种并发编程造成的竞态或死锁问题时，对于功能的思考显得尤为重要。这一类的问题比较难仅通过跑下代码检测出来，通常需要(开发者和审阅者)细致查看才能确保不会引入问题。(同时存在一种原因是：当竞态和死锁问题可能存在时，不要使用并发模型，因为这可能导致代码审阅或者理解代码本身存在一定的复杂度)。



## 复杂度

- 变更本身就比设想的要复杂？任何级别的变更都要进行检查 -- 个人代码是否过于复杂？功能是否过于复杂？类过于复杂？过于复杂通常意味着不能被代码阅读者快速理解。也意味着开发者有可能在调用或者修改这些代码的时候存在bug。
- 一种特别的复杂度叫做："过度设计" ，开发者将代码封装的比其自身更加具有通用性，或者添加一些系统目前不需要使用的功能。审阅者需要对过度设计更加谨慎，鼓励开发者关注解决当前问题而不是超前设计。将来会出现的问题只有在个人发现或者需求提出的时候才需要去解决。



## 测试

- 做合适的变更单元、集成、或者端对端测试。实际上，测试也应该跟生产代码一起放入变更中，除非变更是比较[紧急](https://google.github.io/eng-practices/review/emergencies.html)上线的(hotfix)

- 确保变更中的测试是正确的，合理的，有用的。测试不能测试其自身，我们也基本不会给我们的测试写测试，所以要保证测试是有效的

- 代码出现问题的时候测试也会出现失败用例吗？如果代码变更是以测试为基座的，测试也会出现同样的结果吗？每个测试是否保持简单和可用断言? 不同的测试用例能适当的覆盖分支吗？

- 记住测试也是代码，也需要被维护。不能因为其不是主分支的一部分而接受过于复杂的测试用例

  

## 命名规范

- 开发者有对所有代码赋予一个良好的命名吗？一个好的命名是足够长去充分表达目标项是是啥或者做啥的，命名不够充分会导致比较难阅读



## 注释

- 开发者可以用可理解的英语写清晰的注释吗?是否所有注释都是必须的？通常注释只适用于解释代码存在的合理性而不是解释代码在做什么。如果代码不够清晰去解释自身的话，代码需要尽可能保持更简单。不过还是存在一些例外(举例：正则表达式，复杂算法经常能从解释用法的注释中得到启发)。但是大多数注释用于代码本身不可能包含的信息，例如决策背后的原理
- 查看变更前的评论也很重要，现在有一个待办项可以删掉，但是不要删除变更后的评论
- 前面的注释有可能跟文档中类、模块、函数有出入，这类注释需要保持代码表达的意图、代码应该怎么被使用、还有在使用时功能的行为。



## 风格

- 谷歌内部对于主力开发语言和次要语言都有着全覆盖的[代码风格指南](http://google.github.io/styleguide/) ，确保变更中的代码都要遵循合适的开发风格指南
- 如果你想改进不在风格指南中的某些代码风格点，请以前缀"Nit(润色):  "让开发者知道这是一个你想改进但并不强制的润色点。不要让这些带有个人风格偏好的变更使整个提交处于一个停滞的状态。
- 作者的变更不应该在一个主要风格的变更中混合其他的修改，这会导致变更审阅难度加大，让合并代码和回滚代码变得更加复杂或者导致其他问题出现。举例：如果作者想对整个文件做格式化，一个变更中应该只能有格式化的内容，其他对于功能的修改应该写在其他的变更中。



## 一致性

- 如果现有代码跟风格指南的不一致怎么办？根据[代码审阅原则](),风格指南是绝对权威，如果对风格指南有要求，那么变更就应该遵循指南去走。
- 某些情况中，风格指南是建议性指导而不是明确要求。这些情况需要判断新代码需不需要与已有代码风格保持一致，通常是偏于与风格指南保持一致，不然局部不一致会导致整体风格过于混乱
- 如果没有其他规则应用，作者应该保持写入修改与现有代码保持风格一致
- 同样，鼓励作者以bug fix的形式去整理已有的代码



## 文档

- 如果一个变更需要使用者测试、写交互行为、或者发布代码，则需要检查文档是否需要协同更新。包含README， g3doc pages,或者常规的行为文档。如果变更中删除或者弃用代码，请考虑清楚文档是否需要删除，如果文档缺失，请补全。



## 每一行代码变更

- 常规场景中，每一行代码都需要做代码审视，一些像数据文件，生成的代码，或者巨量数据通常只需要扫视一眼即可，但是人为编写的类，函数、代码块或者是认为可靠的代码都不能粗略一眼带过。特别是一些比其他代码更需要仔细审视的代码，有些权衡就必须要考虑，但是起码得保证你能知道所有的代码是怎么运行的
- 如果在阅读代码的时候比较困难同时审阅的速度在下降的话，这时候需要让开发者知道这一点并且让他们把代码结构整理清晰后再做审阅。谷歌的做法是，招一些比较出色的软件工程师。如果你看不懂这些代码，有可能其他开发者也看不懂，所以你要做的是帮助以后的开发者扫清前面的障碍，能流畅阅读代码。
- 虽然你能理解这些代码，但是对于某些部分的审视不是特别满意，[变更列表中有一位合格的审阅者](https://google.github.io/eng-practices/review/reviewer/looking-for.html#every-line-exceptions) ，特别是对于复杂性较强的问题(安全性，一致性，访问性，国际化等等)

### 异常

- 如果审视到的代码都没有意义怎么办？例如：你是众多审阅者其中一员，有可能被问到：
  - 仅审查较大变更的文件
  - 仅审查变更列表里面某些方面的代码，例如高阶设计，安全影响等等
- 在这些情况下，可以将你审阅的部分记录下一个评论，具体请看:  [代码已经Review过了，可以合并](https://google.github.io/eng-practices/review/reviewer/speed.html#lgtm-with-comments) .

- 如果确认其他审阅者已经审阅完其他部分的变更并且想给与合并支持，请留下一个明确的评论以表明你的合并期望值，以达到[快速响应](https://google.github.io/eng-practices/review/reviewer/speed.html#responses)合并的目的

## 上下文

- 宽泛的上下文对于查看变更有着很大的帮助。通常代码审视工具只会展示修改过的部分行代码，有时你需要查看整个文件确保整个修改是起作用的。例如：审阅者查看四行新增的代码，但是当你在看整个文件的时候，你会发现这四行在一个五十行的方法里面，并且整个方法需要拆分成数个更细颗粒度的方法。
- 从整个系统的上下文中去思考变更也是很有帮助的。此变更是否对整个系统的代码质量有帮助？或者造成整个系统的复杂度增强，更少的测试等等？不能接受变更带来的代码质量下降。大多数系统会通过几个小的变更变得愈发复杂，避免新变更带来的复杂度上升这一点很重要。

## 值得支持的变更

- 如果在变更审阅的时候看到不错的地方，务必要告诉开发者，特别是他们以一个不错的方式解决了一个自己留下的评论时。代码审阅通常仅关注于错误，但是他们的优秀实践也应该被充分赋予鼓励和欣赏。有时告诉开发者做的好的地方比告诉他们做的不足的地方效果更好~

## 总结

- 做代码审查的时候，应该确保：
- 代码是精心设计的
- 此功能评论应该是对用户的代码有好处的
- 任何的用户界面修改都应该是有意义的
- 任何并发编程都做不到安全至上
- 代码不能比其本身的需求更复杂
- 开发者不应该添加现在用不上但是将来可能会用到的东西
- 审阅的代码要上单元测试，要能被测试
- 测试也要精心设计
- 任何命名都必须是清晰的
- 注释必须清晰有效，大部分只是解释为什么或者做了什么
- 代码应该适当留下文档
- 代码应该符合团队自身的代码风格



- 确保审阅每一行要求审查的代码，回顾其上下文，确保你在改进整体代码质量，同时要对于开发者做的好的地方也要提出赞扬。

  

## 下一篇：指路[代码审阅](https://github.com/Trojan0523/Code-Review-Docs/blob/main/Navigating%20a%20CL%20in%20review.md)

